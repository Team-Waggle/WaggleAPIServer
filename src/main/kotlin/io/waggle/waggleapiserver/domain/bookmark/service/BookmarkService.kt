package io.waggle.waggleapiserver.domain.bookmark.service

import io.waggle.waggleapiserver.domain.bookmark.Bookmark
import io.waggle.waggleapiserver.domain.bookmark.BookmarkId
import io.waggle.waggleapiserver.domain.bookmark.BookmarkType
import io.waggle.waggleapiserver.domain.bookmark.dto.request.BookmarkToggleRequest
import io.waggle.waggleapiserver.domain.bookmark.dto.response.BookmarkResponse
import io.waggle.waggleapiserver.domain.bookmark.dto.response.BookmarkToggleResponse
import io.waggle.waggleapiserver.domain.bookmark.repository.BookmarkRepository
import io.waggle.waggleapiserver.domain.post.dto.response.PostDetailResponse
import io.waggle.waggleapiserver.domain.post.repository.PostRepository
import io.waggle.waggleapiserver.domain.recruitment.dto.response.RecruitmentResponse
import io.waggle.waggleapiserver.domain.recruitment.repository.RecruitmentRepository
import io.waggle.waggleapiserver.domain.team.dto.response.TeamSimpleResponse
import io.waggle.waggleapiserver.domain.team.repository.TeamRepository
import io.waggle.waggleapiserver.domain.user.User
import io.waggle.waggleapiserver.domain.user.dto.response.UserSimpleResponse
import org.springframework.stereotype.Service
import org.springframework.transaction.annotation.Transactional

@Service
@Transactional(readOnly = true)
class BookmarkService(
    private val bookmarkRepository: BookmarkRepository,
    private val postRepository: PostRepository,
    private val recruitmentRepository: RecruitmentRepository,
    private val teamRepository: TeamRepository,
) {
    fun toggleBookmark(
        request: BookmarkToggleRequest,
        user: User,
    ): BookmarkToggleResponse {
        val (targetId, type) = request

        val bookmarkId =
            BookmarkId(
                userId = user.id,
                targetId = targetId,
                type = type,
            )
        return if (bookmarkRepository.existsById(bookmarkId)) {
            bookmarkRepository.deleteById(bookmarkId)
            BookmarkToggleResponse(false)
        } else {
            val bookmark = Bookmark(bookmarkId)
            bookmarkRepository.save(bookmark)
            BookmarkToggleResponse(true)
        }
    }

    fun getUserBookmarkables(
        type: BookmarkType,
        user: User,
    ): List<BookmarkResponse> {
        val targetIds =
            bookmarkRepository
                .findByIdUserIdAndIdType(user.id, type)
                .map { it.targetId }

        return when (type) {
            BookmarkType.POST -> {
                val posts = postRepository.findByIdInOrderByCreatedAtDesc(targetIds)
                val recruitmentsByPostId =
                    recruitmentRepository.findByPostIdIn(posts.map { it.id }).groupBy { it.postId }
                posts.map { post ->
                    val recruitments =
                        (recruitmentsByPostId[post.id] ?: emptyList()).map { RecruitmentResponse.from(it) }
                    PostDetailResponse.of(post, UserSimpleResponse.from(user), recruitments)
                }
            }

            BookmarkType.TEAM -> {
                teamRepository
                    .findByIdInOrderByCreatedAtDesc(targetIds)
                    .map { TeamSimpleResponse.from(it) }
            }
        }
    }
}
